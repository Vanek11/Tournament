name: Update tournament stats

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # каждые 6 часов, можно реже/чаще

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # ставим браузеры для playwright (для редкого фоллбэка/будущего)
          python -m pip install playwright
          python -m playwright install chromium
        continue-on-error: true

      - name: Scrape with retries (soft-fail)
        env:
          RETRIES: "3" # сколько повторов на каждый профиль
          CONNECT_TIMEOUT: "20" # таймаут соединения (сек)
          READ_TIMEOUT: "45" # таймаут чтения (сек)
          CI_SOFT_FAIL: "1" # не падать, если сеть недоступна
        run: |
          python - << 'PY'
          import os, sys, time, subprocess
          retries = int(os.getenv("RETRIES","3"))
          conn_to = int(os.getenv("CONNECT_TIMEOUT","20"))
          read_to = int(os.getenv("READ_TIMEOUT","45"))
          # Прокинем таймауты в скрапер через env
          os.environ["SCRAPE_CONNECT_TIMEOUT"] = str(conn_to)
          os.environ["SCRAPE_READ_TIMEOUT"] = str(read_to)

          cmd = ["python", "scrape_lesta.py", "--input", "participants.json", "--out", "stats", "--delay", "1.5"]
          ok = False
          for i in range(1, retries+1):
            print(f"Attempt {i}/{retries} ...", flush=True)
            rc = subprocess.call(cmd)
            if rc == 0:
              ok = True
              break
            time.sleep(5*i)
          if not ok:
            # «мягкий» выход — не ломаем пайплайн, просто оставляем прошлые stats
            print("WARN: scrape failed after retries; keeping previous stats", file=sys.stderr)
            if os.getenv("CI_SOFT_FAIL") == "1":
              sys.exit(0)
            else:
              sys.exit(1)
          PY

      - name: Commit stats if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add stats
          if git diff --cached --quiet; then
            echo "No stats changes"
          else
            git commit -m "chore(stats): refresh"
            git push
          fi
