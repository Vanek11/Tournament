name: Update tournament stats

on:
  workflow_dispatch: {}
  schedule:
    - cron: "23 */6 * * *" # каждые 6 часов
  push:
    paths:
      - "js/data.participants.js"
      - "scrape_lesta.py"
      - ".github/workflows/scrape.yml"

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install deps (pip + Playwright)
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Generate participants.json from js/data.participants.js
        run: |
          python - << 'PY'
          import re, json, sys, pathlib
          p = pathlib.Path("js/data.participants.js")
          text = p.read_text(encoding="utf-8")
          m = re.search(r'participants\s*=\s*(\[[\s\S]*?\])', text)
          if not m:
              sys.exit("participants array not found in js/data.participants.js")
          arr = json.loads(m.group(1))
          pathlib.Path("participants.json").write_text(
              json.dumps(arr, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )
          print("participants.json generated with", len(arr), "records")
          PY

      - name: Run scraper
        run: python scrape_lesta.py --input participants.json --out stats --delay 1.5

      - name: Build stats/index.json (aggregate)
        run: |
          python - << 'PY'
          import json, glob, os, pathlib
          data = {}
          for path in glob.glob("stats/*.json"):
              base = os.path.basename(path)
              if base in ("index.json", "all.json"): 
                  continue
              d = json.load(open(path, encoding="utf-8"))
              key = str(d.get("accountId") or os.path.splitext(base)[0])
              data[key] = d
          out = pathlib.Path("stats/index.json")
          out.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
          print("Wrote", out, "with", len(data), "records")
          PY

      - name: Commit stats
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add stats/*.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update stats [skip ci]"
            git push
          fi
